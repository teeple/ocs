<?php

module_load_include( 'inc', 'ocs_admin', 'ocs_account');
module_load_include( 'inc', 'ocs_admin', 'ocs_group');

/***
* Implementation of hook_menu
*/
function ocs_admin_menu() {

    $items['helloworld'] = array(
        'title' => 'Hello World',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_account_add_form'),
        'access arguments' => array('access content'),
    );

    $items['helloworld/%ctools_js/form'] = array(
        'title' => 'AJAX World',
        'page callback' => 'ocs_admin_modal',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
    );

    $items['ocs_admin/account/add/%'] = array(
        'title' => 'Add New Account',
        'page callback' => 'ocs_admin_account_add',
        'page arguments' => array(3),
        'access arguments' => array('access content'),
    );

    $items['ocs_admin/account/add/%/%ctools_js/%/%/%'] = array(
        'title' => 'Callback for adding a new account',
        'page callback' => 'ocs_account_select',
        'page arguments' => array( 3, 4, 5, 6, 7),     // nojs/type/id/name i.e. customer/1/tom
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
    );

    $items['ocs_admin/group/%group'] = array(
        'title' => 'Edit Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_form', 2),
        'access arguments' => array('access content'),
        'file' => 'ocs_group.inc',
     );

    $items['ocs_admin/group/%group/edit'] = array(
        'title' => 'Edit Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_edit_form', 'edit', 2),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/add'] = array(
        'title' => 'Add Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_edit_form', 'add', 2),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
        'file' => 'ocs_group.inc',
    );

     $items['ocs_admin/group/%group/list'] = array(
        'title' => 'List Sub Groups',
        'weight' => -10,
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
     );

    $items['ocs_admin/group/%group/add'] = array(
        'title' => 'Add Sub Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_subgroup_form', 'add', 2),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_ACTION,
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/%group/delete'] = array(
        'title callback' => 'ocs_admin_group_title',
        'title arguments' => array('Delete', 2),
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_delete_subgroup_confirm', 2),
        'access arguments' => array('access content'),
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/%group/member/%/edit'] = array(
        'title' => 'Edit Member',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_member_edit_form', 2, 4),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/%group/member/%/delete'] = array(
        'title' => 'Delete a Member',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_member_delete_confirm', 2, 4),
        'access arguments' => array('access content'),
        'file' => 'ocs_group.inc',
    );

    // MAX_MENU_PATH is 9
    $items['ocs_admin/group/%group/addmember/%ctools_js/%/%/%'] = array(
        'title' => 'Callback for adding a new member',
        'page callback' => 'ocs_member_select',
        'page arguments' => array( 2, 4, 5, 6, 7),     // nojs/type/id/name i.e. customer/1/tom
        'access arguments' => array('access content'),
        'access arguments' => TRUE,
        'type' => MENU_CALLBACK,
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/card/cardtype/%'] = array(
        'title' => 'Add Card Type',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_card_form', 'add', 3),
        'access arguments' => array('access content'),
        'file' => 'ocs_card.inc',
    );

    $items['ocs_admin/card/product/%/add'] = array(
        'title' => 'Related Product',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_product_card', 'add', 3),
        'access arguments' => array('access content'),
        'file' => 'ocs_card.inc',
    );

    return $items;
}

/*
** implement hook_theme()
*/
function ocs_admin_theme()
{
    return array(
        'ocs_admin_group_form' => array(
            'file' => 'ocs_group.inc',
            'render element' => 'form',
        ),
        'ocs_admin_group_overview' => array(
            'file' => 'ocs_group.inc',
            'variables' => array( 'title' => NULL, 'name' => NULL, 'description' => NULL),
        ),
    );
}


/*
* Menu callback to say hello to the world
*/
function helloworld() {
    /*
    db_set_active('ocsdb');    // activation & execution same as explained above

    $result = db_select( 'ocs_customer')
        ->fields( 'ocs_customer', array( 'customer_id', 'customer_name'))
        ->execute();

    $output = "";
    while($record = $result->fetchAssoc()) {
        $output = $output.print_r($record, TRUE);
    }

    db_set_active('default'); // set back to original

    return $output;
    */
    ctools_include('ajax'); // Module  include the dependence it needs for ajax.
    ctools_include('modal');
    ctools_modal_add_js();

    $block['account'] = module_invoke( 'views', 'block_view', 'ocs_account-block2');
    $block['product'] = module_invoke( 'views', 'block_view', 'ocs_product-block');

    $form = drupal_get_form( 'ocs_account_add_form');
    $output = drupal_render( $form);

    return array(
        /*
        'first form' => array( 
            '#type' => 'markup',
            '#markup' => $output,
            '#prefix' => '<div id="ocs_account_add_form">',
            '#suffix' => '</div>',
            '#post_render' => array( 'ocs_account_add_form_post_render'),
            ),
        'kpr form' => array( 
            '#markup' => kpr( $table, TRUE),
            ),
        'kpr output' => array( 
            '#markup' => kpr( $output, TRUE),
            ),
            */
        'account' => $block['account']['content'],
        'kpr account' => array( 
            '#markup' => kpr( $block['account']['content'], TRUE),
            ),
            /*
        'product' => $block['product']['content'],
        */
    );
}

/*
** tried to implement modal popup to select customer or product
*/
function ocs_admin_modal( $js = NULL)
{
    if ( $js) {
        ctools_include('ajax');
        ctools_include('modal');
    }

    $block = module_invoke( 'views', 'block_view', 'ocs_account-block');

    $form = ocs_admin_modal_submit_form( 'ocs_admin_modal_submit_form');
    $render = array(
        'title' => array(
            '#type' => 'markup',
            '#markup' => '<h2>Select Customer</h2>',
        ),

        'view' => $block['content'],

        'form' => $form,
    );

    if ( $js) {
        $command = array();
        $command = ctools_modal_form_render( $form_state, $render);
        print ajax_render( $command);
        exit;
    }
    else {
        return $render;
    }
}

function ocs_admin_modal_submit_form()
{
    /*
    $form['form_var'] = array(
        '#type' => 'markup',
        '#markup' => 'form',
        '#prefix' => '<div id="ocs_admin_modal_submit_form">',
        '#suffix' => '</div>',
        );
    */

    $form['submit'] = array(
        '#type' => 'button',
        '#value' => 'Submit',
    );

    return $form;
}

/*
* Enable views to load this module
*/
function ocs_admin_views_api() {
      return array('api' => 3.0);
}

/*
function ocs_admin_taxonomy_term_insert($term) {
  if (!empty($term->synonyms)) {
    foreach (explode("\n", str_replace("\r", '', $term->synonyms)) as $synonym) {
      if ($synonym) {
        db_insert('taxonomy_term_synonym')
        ->fields(array(
          'tid' => $term->tid, 
          'name' => rtrim($synonym),
        ))
        ->execute();
      }
    }
  }
}

function ocs_admin_taxonomy_term_load($terms) {
  $result = db_query('SELECT tid, name FROM taxonomy_term_synonym ');
  foreach ($result as $record) {
    $terms[$record->tid]->foo = $record->foo;
  }
}
*/

/*
    load group 
*/
function group_load( $groupid) 
{
    $all_group = group_load_all();
    return isset( $all_group[$groupid]) ? $all_group[$groupid] : FALSE;
}

/*
    load all group
*/
function group_load_all()
{
   $groups = &drupal_static(__FUNCTION__);
   if ( !isset( $groups)) {
       db_set_active('ocsdb');

       $query = db_select( 'ocs_group', 'g');
       $groups = $query->fields( 'g')
            ->execute()
            ->fetchAllAssoc( 'group_id', PDO::FETCH_ASSOC);

//        dpm( $groups, 'fetched groups');

        db_set_active('default');
    } 

    return $groups;
}


/*
    save OCS Customer Group
*/
function ocs_admin_group_save( $group)
{
    db_set_active( 'ocsdb');

    $fields = array( 
        'group_id' => isset($group['group_id']) ? $group['group_id'] : NULL,
        'ancestor_group_id' => isset($group['ancestor_group_id']) ? $group['ancestor_group_id'] : 0,
        'parent_group_id' => isset($group['parent_group_id']) ? $group['parent_group_id'] : 0,
        'group_name' => isset($group['group_name']) ? $group['group_name'] : NULL,
        'service_type' => isset($group['service_type']) ? $group['service_type'] : 0,
        );
    if ( isset( $group['master_number']))
        $fields['master_number'] = $group['master_number'];

    if ( isset( $group['group_id'])) {
        $status = db_merge( 'ocs_group')
            ->key( array( 'group_id' => $group['group_id']))
            ->fields( $fields)
            ->execute();
        dpm( $status, 'db_merge result');
    }
    else {
        // insert
        $options = array('return' => Database::RETURN_INSERT_ID);
        $last_insert_id = db_insert( 'ocs_group', $options)
            ->fields( $fields)
            ->execute();
        dpm( $last_insert_id, 'db_insert result');

        // update ancestor_group_id
        if ( $fields['ancestor_group_id'] == 0 && $last_insert_id > 0) {
            $result = db_update( 'ocs_group')
                ->fields( array(
                    'ancestor_group_id' => $last_insert_id
                ))
                ->condition( 'group_id', $last_insert_id, '=')
                ->execute();
            dpm( $result, 'db_update result');
        }
    }

    db_set_active( 'default');
}

function ocs_admin_group_delete( $group)
{
    db_set_active( 'ocsdb');

    // delete the group and all subgroups
    $status = db_delete( 'ocs_group')
        ->condition( 'ancestor_group_id', $group['group_id'])
        ->execute();
    dpm( $status, 'db_delete result');

    db_set_active( 'default');
}

function ocs_admin_subgroup_delete( $group)
{
    db_set_active( 'ocsdb');

    // delete
    $status = db_delete( 'ocs_group')
        ->condition( 'group_id', $group['group_id'])
        ->execute();
    dpm( $status, 'db_delete result');

    // update
    $status = db_update( 'ocs_group')
        ->fields( array(
            'parent_group_id' => $group['parent_group_id']
            ))
        ->condition( 'ancestor_group_id', $group['ancestor_group_id'], '=')
        ->condition( 'parent_group_id', $group['group_id'], '=')
        ->execute();
    dpm( $status, 'db_update result');

    db_set_active( 'default');
}

/*
    save OCS Customer Account
*/
function ocs_admin_account_save( $account)
{
    db_set_active( 'ocsdb');

    $fields = array( 
        'account_key' => isset($account['account_key']) ? $account['account_key'] : NULL,
        'status' => 0,
        'subscription_key' => isset($account['subscription_key']) ? $account['subscription_key'] : '0',
        'customer_id' => isset($account['customer_id']) ? $account['customer_id'] : '0',
        'product_id' => isset($account['product_id']) ? $account['product_id'] : 0,
        );

     // insert
    $status = db_insert( 'ocs_account')
        ->fields( $fields)
        ->execute();
    dpm( $status, 'db_insert result');

    db_set_active( 'default');
}

/*
    save OCS group member 
*/
function ocs_admin_member_save( $member)
{
    db_set_active( 'ocsdb');

    $fields = array( 
        'group_id' => isset($member['group_id']) ? $member['group_id'] : 0,
        'ancestor_group_id' => isset($member['ancestor_group_id']) ? $member['ancestor_group_id'] : 0,
        'account_key' => isset($member['account_key']) ? $member['account_key'] : NULL,
        'extension' => isset($member['extension']) ? $member['extension'] : '000',
        'limitation' => isset($member['limitation']) ? $member['limitation'] : 0,
//        'usage' => isset($member['usage']) ? $member['usage'] : 0,
//        'next_reset_date' => isset($member['next_reset_date']) ? $member['next_reset_date'] : 0,
        );

     // insert
     $status = db_merge( 'ocs_group_member')
        ->key( array( 'account_key' => $member['account_key']))
        ->fields( $fields)
        ->execute();
    dpm( $status, 'db_merge result');

    db_set_active( 'default');
}


/*
    load member info
*/
function ocs_admin_member_load( $account_key)
{
   db_set_active('ocsdb');

   $query = db_select( 'ocs_group_member', 'g');
   $result = $query->fields( 'g')
        ->condition( 'account_key', $account_key, '=')
        ->execute();

    $member = $result->fetchAssoc();
    dpm( $member, 'fetched group member');

    db_set_active('default');

    return $member;
}


/*
    delete member info
*/
function ocs_admin_member_delete( $account_key)
{
   db_set_active('ocsdb');

   $result = db_delete( 'ocs_group_member')
        ->condition( 'account_key', $account_key, '=')
        ->execute();

    dpm( $result, 'db_delete group member');

    db_set_active('default');

    return $result;
}

/*
    add card type
*/
function ocs_admin_card_form_save( $cardtype)
{
	
  db_set_active( 'ocsdb');
  $card_type = strtoupper($cardtype['card_type']);

  $fields = array( 
      'card_type' =>  isset($card_type) ?  $card_type : NULL,
      'unit' => isset($cardtype['unit']) ? $cardtype['unit'] : NULL,
      'active_period' => isset($cardtype['active_period']) ? $cardtype['active_period'] : NULL,
      'grace_period' => isset($cardtype['grace_period']) ? $cardtype['grace_period'] : NULL,
      'description' => isset($cardtype['description']) ? $cardtype['description'] : NULL,
      );

  if ( isset( $cardtype['card_type'])) {
      $status = db_merge( 'ocs_card_type')
          ->key( array( 'card_type' => $cardtype['card_type']))
          ->fields( $fields)
          ->execute();
      dpm( $status, 'db_merge result');
  }
  else {
      // insert
      $options = array('return' => Database::RETURN_INSERT_ID);
      $last_insert_id = db_insert( 'ocs_card_type', $options)
          ->fields( $fields)
          ->execute();
      dpm( $last_insert_id, 'db_insert result');
  }

  db_set_active( 'default');
  return 1;
}

function ocs_admin_form_alter(&$form, &$form_state, $form_id)
{
/*
  if ($form_id == 'ocs_admin_card_form')
  {
	  if (ChkParamRule($form_state['input']['unit'], 'int') != 1) {
			dpm('Invalid unit data!');
	  	return 0;
	  }
  }
  return 1;

  if (ChkParamRule($cardtype['unit'], 'int') != 1){
		dpm('Invalid unit data!');
  	return 0;
  }
  
  if (ChkParamRule($cardtype['active_period'], 'int') != 1){
		dpm(' Invalid active period data!');
  	return 0;
  }
  
  if (ChkParamRule($cardtype['grace_period'], 'int') != 1) {
		dpm('Invalid grace period data!');
  	return 0;
  }
  
  
*/
}

/*
    Parameter Check
*/
function ChkParamRule($obj, $rule)
{
	$chk = 1;
	$obj = trim($obj);
	
	if($obj){
		//English
		if('en' == $rule){
			if(preg_match("/[a-zA-Z]/", $obj)) $chk = 0;
		}

		//Number
		if('int' == $rule){
			if(preg_match("/[0-9]/", $obj)) $chk = 0;
		}

		// Special
		if('special' == $rule){
			if(preg_match("/[!#$%^&*()?+=\/]/", $obj)) $chk = 0;
		}

		return $chk;
	}
}