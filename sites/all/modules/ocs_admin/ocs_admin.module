<?php

module_load_include( 'inc', 'ocs_admin', 'ocs_account');
module_load_include( 'inc', 'ocs_admin', 'ocs_group');

/***
* Implementation of hook_menu
*/
function ocs_admin_menu() {
    $items['helloworld'] = array(
        'title' => 'Hello World',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_account_add_form'),
        'access arguments' => array('access content'),
    );

    $items['helloworld/%ctools_js/form'] = array(
        'title' => 'AJAX World',
        'page callback' => 'ocs_admin_modal',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
    );

    $items['ocs_admin/account/add/%'] = array(
        'title' => 'Add New Account',
        'page callback' => 'ocs_admin_account_add',
        'page arguments' => array(3),
        'access arguments' => array('access content'),
    );

    $items['ocs_admin/account/add/%/%ctools_js/select/%/%/%'] = array(
        'title' => 'Callback for adding a new account',
        'page callback' => 'ocs_account_select',
        'page arguments' => array( 3, 4, 6, 7, 8),     // nojs/type/id/name i.e. customer/1/tom
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
    );

    $items['ocs_admin/group/manage/%group'] = array(
        'title' => 'Customer Group Information',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_form', 3),
        'title callback' => 'ocs_admin_group_title',
        'title arguments' => array('Edit'),
        'access arguments' => array('access content'),
        'file' => 'ocs_group.inc',
     );

    $items['ocs_admin/group/manage/%group/list'] = array(
        'title' => 'List Sub Groups',
        'weight' => -10,
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
     );

    $items['ocs_admin/group/manage/%group/add'] = array(
        'title' => 'Add Sub Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_subgroup_form', 'add', 3),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_ACTION,
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/manage/%group/delete'] = array(
        'title' => 'Delete Sub Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_delete_subgroup_confirm', 3),
        'access arguments' => array('access content'),
        'file' => 'ocs_group.inc',
    );

    $items['ocs_admin/group/manage/%group/edit'] = array(
        'title' => 'Edit Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_edit_form', 'edit', 3),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
        'file' => 'ocs_group.inc',
    );

    /*
    $items['ocs_admin/group/manage/%group/member'] = array(
        'title' => 'Add Members to Group',
        'page callback' => 'drupal_get_form',
        'page arguments' => array( 'ocs_admin_group_member_form', 'add', 3),
        'access arguments' => array('access content'),
        'type' => MENU_LOCAL_TASK,
        'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
        'file' => 'ocs_group.inc',
    );
    */


    return $items;
}

/*
** implement hook_theme()
*/
function ocs_admin_theme()
{
    return array(
        'ocs_admin_group_form' => array(
            'file' => 'ocs_group.inc',
            'render element' => 'form',
        ),
        'ocs_admin_group_overview' => array(
            'file' => 'ocs_group.inc',
            'variables' => array( 'title' => NULL, 'name' => NULL, 'description' => NULL),
        ),
    );
}


/*
* Menu callback to say hello to the world
*/
function helloworld() {
    /*
    db_set_active('ocsdb');    // activation & execution same as explained above

    $result = db_select( 'ocs_customer')
        ->fields( 'ocs_customer', array( 'customer_id', 'customer_name'))
        ->execute();

    $output = "";
    while($record = $result->fetchAssoc()) {
        $output = $output.print_r($record, TRUE);
    }

    db_set_active('default'); // set back to original

    return $output;
    */
    ctools_include('ajax'); // Module  include the dependence it needs for ajax.
    ctools_include('modal');
    ctools_modal_add_js();

    $block['account'] = module_invoke( 'views', 'block_view', 'ocs_account-block2');
    $block['product'] = module_invoke( 'views', 'block_view', 'ocs_product-block');

    $form = drupal_get_form( 'ocs_account_add_form');
    $output = drupal_render( $form);

    return array(
        /*
        'first form' => array( 
            '#type' => 'markup',
            '#markup' => $output,
            '#prefix' => '<div id="ocs_account_add_form">',
            '#suffix' => '</div>',
            '#post_render' => array( 'ocs_account_add_form_post_render'),
            ),
        'kpr form' => array( 
            '#markup' => kpr( $table, TRUE),
            ),
        'kpr output' => array( 
            '#markup' => kpr( $output, TRUE),
            ),
            */
        'account' => $block['account']['content'],
        'kpr account' => array( 
            '#markup' => kpr( $block['account']['content'], TRUE),
            ),
            /*
        'product' => $block['product']['content'],
        */
    );
}

/*
** tried to implement modal popup to select customer or product
*/
function ocs_admin_modal( $js = NULL)
{
    if ( $js) {
        ctools_include('ajax');
        ctools_include('modal');
    }

    $block = module_invoke( 'views', 'block_view', 'ocs_account-block');

    $form = ocs_admin_modal_submit_form( 'ocs_admin_modal_submit_form');
    $render = array(
        'title' => array(
            '#type' => 'markup',
            '#markup' => '<h2>Select Customer</h2>',
        ),

        'view' => $block['content'],

        'form' => $form,
    );

    if ( $js) {
        $command = array();
        $command = ctools_modal_form_render( $form_state, $render);
        print ajax_render( $command);
        exit;
    }
    else {
        return $render;
    }
}

function ocs_admin_modal_submit_form()
{
    /*
    $form['form_var'] = array(
        '#type' => 'markup',
        '#markup' => 'form',
        '#prefix' => '<div id="ocs_admin_modal_submit_form">',
        '#suffix' => '</div>',
        );
    */

    $form['submit'] = array(
        '#type' => 'button',
        '#value' => 'Submit',
    );

    return $form;
}

/*
* Enable views to load this module
*/
function ocs_admin_views_api() {
      return array('api' => 3.0);
}

/*
function ocs_admin_taxonomy_term_insert($term) {
  if (!empty($term->synonyms)) {
    foreach (explode("\n", str_replace("\r", '', $term->synonyms)) as $synonym) {
      if ($synonym) {
        db_insert('taxonomy_term_synonym')
        ->fields(array(
          'tid' => $term->tid, 
          'name' => rtrim($synonym),
        ))
        ->execute();
      }
    }
  }
}

function ocs_admin_taxonomy_term_load($terms) {
  $result = db_query('SELECT tid, name FROM taxonomy_term_synonym ');
  foreach ($result as $record) {
    $terms[$record->tid]->foo = $record->foo;
  }
}
*/

/*
    load group 
*/
function group_load( $groupid) 
{
    $all_group = group_load_all();
    return isset( $all_group[$groupid]) ? $all_group[$groupid] : FALSE;
}

/*
    load all group
*/
function group_load_all()
{
   $groups = &drupal_static(__FUNCTION__);
   if ( !isset( $groups)) {
       db_set_active('ocsdb');

       $query = db_select( 'ocs_group', 'g');
       $groups = $query->fields( 'g')
            ->execute()
            ->fetchAllAssoc( 'group_id', PDO::FETCH_ASSOC);

//        dpm( $groups, 'fetched groups');

        db_set_active('default');
    } 

    return $groups;
}


/*
    save OCS Customer Group
*/
function ocs_admin_group_save( $group)
{
    db_set_active( 'ocsdb');

    $fields = array( 
        'group_id' => isset($group['group_id']) ? $group['group_id'] : NULL,
        'ancestor_group_id' => isset($group['ancestor_group_id']) ? $group['ancestor_group_id'] : 0,
        'parent_group_id' => isset($group['parent_group_id']) ? $group['parent_group_id'] : 0,
        'group_name' => isset($group['group_name']) ? $group['group_name'] : NULL,
        'service_type' => isset($group['service_type']) ? $group['service_type'] : 0,
        );
    if ( isset( $group['master_number']))
        $fields['master_number'] = $group['master_number'];

    if ( isset( $group['group_id'])) {
        $status = db_merge( 'ocs_group')
            ->key( array( 'group_id' => $group['group_id']))
            ->fields( $fields)
            ->execute();
        dpm( $status, 'db_merge result');
    }
    else {
        // insert
        $status = db_insert( 'ocs_group')
            ->fields( $fields)
            ->execute();
        dpm( $status, 'db_insert result');
    }

    db_set_active( 'default');
}

function ocs_admin_group_delete( $group)
{
    db_set_active( 'ocsdb');

    // delete
    $status = db_delete( 'ocs_group')
        ->condition( 'group_id', $group['group_id'])
        ->execute();
    dpm( $status, 'db_delete result');

    // update
    $status = db_update( 'ocs_group')
        ->fields( array(
            'parent_group_id' => $group['parent_group_id']
            ))
        ->condition( 'ancestor_group_id', $group['ancestor_group_id'], '=')
        ->condition( 'parent_group_id', $group['group_id'], '=')
        ->execute();
    dpm( $status, 'db_update result');

    db_set_active( 'default');
}

/*
    save OCS Customer Account
*/
function ocs_admin_account_save( $account)
{
    db_set_active( 'ocsdb');

    $fields = array( 
        'account_key' => isset($account['account_key']) ? $account['account_key'] : NULL,
        'status' => 0,
        'subscription_key' => isset($account['subscription_key']) ? $account['subscription_key'] : '0',
        'customer_id' => isset($account['customer_id']) ? $account['customer_id'] : '0',
        'product_id' => isset($account['product_id']) ? $account['product_id'] : 0,
        );

     // insert
    $status = db_insert( 'ocs_account')
        ->fields( $fields)
        ->execute();
    dpm( $status, 'db_insert result');

    db_set_active( 'default');
}

